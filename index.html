<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Together – Solid Mobile Scroll (Dual Rain, No H-Scroll)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --lavender: #C98AF7;
      --deep-purple: rgba(155, 75, 222, 0.3);
      --fall-distance: 100vh; /* fallback */
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;width:100%; overflow-x:hidden;}
    body{
      background:#111;
      display:block;
      font-family:"Poppins", sans-serif;
      min-height:100vh;
      overflow-y:auto;
      padding:max(16px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right)) max(16px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .fit{
      position:relative;
      width:100%;
      max-width:1242px;
      /* Giữ nguyên chiều rộng, chiều cao dài hơn (bản hiện tại của bạn dùng ~8000px) */
      aspect-ratio:1242/9500;
      background:var(--lavender);
      overflow-y:auto; /* chỉ cuộn dọc */
      overflow-x:hidden; /* không cuộn ngang */
      border-radius:20px;
      margin:0 auto;
      touch-action:pan-y; /* tránh pan-x vô tình */
      overscroll-behavior:contain;
      -webkit-overflow-scrolling:touch;
      contain:layout paint size; /* cô lập để tránh reflow lan rộng trên mobile */
    }

    /* Nửa trên: giữ đúng bố cục ban đầu */
    .original{position:relative; width:100%; aspect-ratio:1242/2688; background:transparent; overflow:hidden; z-index:2}
    .phone{position:absolute; inset:0; background:var(--lavender); overflow:hidden}

    /* RAIN: chuyển từ fixed (100vh/100vw) sang absolute theo từng container để tránh glitch khi cuộn nhanh */
    .rain{position:absolute; inset:0; width:100%; height:100%; pointer-events:none; z-index:2}
    .drop{position:absolute; top:-60px; user-select:none; will-change:transform, opacity;}
    .drop.heart{color:#9B4BDE}
    .drop.cat{filter:saturate(1.1)}
    @keyframes fallFade{ 0%{transform:translateY(-60px) rotate(0deg); opacity:1} 70%{opacity:0.35} 100%{transform:translateY(calc(var(--fall-distance, 100vh) + 60px)) rotate(25deg); opacity:0} }

    .title{position:absolute; left:6%; top:3%; color:#fff; font-weight:600; font-size:clamp(32px, 7vw, 90px); letter-spacing:1px; z-index:5}
    @media (max-width:600px){.title{top:2%}}
    .main-card{position:absolute; left:10%; right:10%; top:12%; height:35%; background:var(--deep-purple); border-radius:8vw; color:#fff; display:grid; place-items:center; z-index:3; padding:10px}
    .main-card .stack{text-align:center; line-height:2.12}
    .main-card .stack div{font-size:clamp(20px, 6vw, 72px); font-weight:600}
    .label{font-size:clamp(12px, 3vw, 42px); font-weight:400; margin-left:1vw}
    .img-box{position:absolute; left:12%; right:12%; bottom:6%; aspect-ratio:1/1; border-radius:3vw; overflow:hidden; background:#fff; box-shadow:0 2vw 5vw rgba(0,0,0,.25); z-index:4; display:flex; align-items:center; justify-content:center; transform:scale(0.75)}
    .img-stack{position:relative; width:100%; height:100%}
    .img-stack img{position:absolute; width:100%; height:100%; object-fit:cover; border-radius:2vw; transition:all .6s ease; image-rendering:-webkit-optimize-contrast; image-rendering:crisp-edges}
    #imgStack img{opacity:.8 !important}
    .img-stack img:nth-child(1){z-index:5; top:0; left:0}
    .img-stack img:nth-child(2){z-index:4; top:-1.2vw; left:-1.2vw}
    .img-stack img:nth-child(3){z-index:3; top:-2.4vw; left:-2.4vw}
    .img-stack img:nth-child(4){z-index:2; top:-3.6vw; left:-3.6vw}
    .img-stack img:nth-child(5){z-index:1; top:-4.8vw; left:-4.8vw}
    .img-box.secondary{left:50%; top:70%; transform:translateX(-50%) scale(1.35)}

    /* Nửa dưới: message ở TRÊN lớp mưa thứ 2 */
    .extra{position:relative; width:100%; padding:24px 20px 40px; display:flex; align-items:flex-start; justify-content:center; background:linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,.12)); z-index:10}
    .extra .rain{z-index:9}
    .message-box{position:relative; z-index:11; width:min(92%, 1000px); background: rgba(201, 138, 247, 0.9); color:#fff; border-radius:16px; box-shadow:0 12px 28px rgba(0,0,0,.24); padding:16px 18px}
    .message-box h3{font-size:18px; margin-bottom:8px; color:#fff}
    .message-box p{font-size:14px; line-height:1.65; color:#fff}
  </style>
</head>
<body>
  <div class="fit" id="fit">
    <!-- Lớp mưa cho nửa trên -->
    <section class="original" id="original">
      <main class="phone">
        <div class="rain" id="rainTop"></div>
        <h1 class="title">TOGETHER</h1>
        <section class="main-card">
          <div class="stack">
            <div><span id="yearVal">0</span><span class="label">years</span></div>
            <div><span id="dayVal">0</span><span class="label">days</span></div>
            <div><span id="secondVal">0</span><span class="label">seconds</span></div>
          </div>
        </section>
        <div class="img-box">
          <div class="img-stack" id="imgStack"></div>
        </div>
        <div class="img-box secondary">
          <div class="img-stack" id="imgStackSecondary"></div>
        </div>
      </main>
    </section>

    <!-- Nửa dưới: lớp mưa riêng + message-box nằm TRÊN -->
    <section class="extra" id="extra">
      <div class="rain" id="rainExtra"></div>
      <div class="message-box">
        <h3>💜</h3>
        <p id="extraText">Cả 1 quá trình, 1 chặng đường, từ cái lúc còn chưa biết mặt nhau, chỉ tình cờ đùa với nhau vài câu, rồi nhắn tin với nhau mà rồi thích nhau, yêu nhau, rồi cãi vã, rồi lại thương, rồi không hiểu nhau, lại cãi nhau, rồi lại hiểu nhau hơn, cùng nhau từ những ngày đầu đặt chân đến trường, cùng nhau tốt nghiệp, cùng đi gần đi xa, trải qua không biết bao nhiêu chuyện lớn nhỏ, mục đích cuối cùng vẫn là để ở bên nhau, nghĩ về tương lai. Vậy mà chỉ vì khoảng thời gian này nguyên nhân chính là không có thời gian bên nhau mà lại xa nhau, không lỗi lầm quá đáng không thể tha thứ, không có nguyên nhân đủ nặng, không người thứ 3, vậy mà lại dễ dàng từ bỏ!

<br><br>Anh biết mình đã qua cái khoảng thời gian mà cần nhau, nhớ nhau nhiều tới mức chỉ muốn ở cạnh, mỗi giai đoạn mỗi thời điểm mọi thứ cũng sẽ thay đổi theo. Bây giờ cũng vậy, không cần phải lúc nào cũng phải kè bên nhau, em cần có không gian riêng, anh cũng vậy. Nhưng chỉ cần những lúc như có việc đi xa thì có người đồng hành, lúc có làm sao có đi bệnh viện thì có người đi cùng, có 1 người để trò chuyện, để tâm sự. Anh nhận ra đó mới là cái hiện tại anh và em cần, trước giờ anh hong có suy nghĩ vậy, hôm nay anh mới ngẫm lại thì anh cảm thấy trước giờ 2 đứa mình ở bên cạnh nhau chỉ nghĩ cần nhau, có tình cảm là đủ, nhưng mà thời điểm này, thời gian bên nhau không có, thì anh nghĩ quan tâm nhau mới là cái quan trọng nhất. Không phải là trước giờ anh không quan tâm em, chỉ là chưa đủ, anh không nói ra nhưng lúc nào anh cũng nghĩ em cần gì, em thích gì để anh mua cho em vui, nhưng anh không nhận ra em cần sự chia sẻ, sự kết nối hơn là điều đó. Em cũng quan tâm anh nhưng càng ngày càng ít đi vì em không có thời gian nghĩ tới nữa, anh hiểu!! Hay là em cứ chấp nhận, cứ để anh thay đổi cách mình quen nhau, thay đổi luôn cả cách nhìn nhận, đối xử với nhau nhẹ nhàng hơn.

<br><br>Mấy hôm nay anh suy nghĩ nhiều lắm, về từng chuyện lớn nhỏ xưa giờ, anh nghĩ mình cũng đã thực sự hiểu, cũng tới lúc anh phải trưởng thành rồi. Nhưng anh vẫn muốn có em ở cạnh, vẫn muốn em là ưu tiên của anh, anh cũng không cần em phải thay đổi gì đâu, chỉ là anh muốn anh sẽ thay đổi cách anh đối xử với em thôi. 7 năm qua em quen, em yêu 1 đứa con nít, bây giờ anh biết đã đến lúc em cần 1 người trưởng thành hơn.

<br><br>Thử cùng nhau cố gắng 1 lần, thay đổi cách suy nghĩ 1 lần, cùng hướng tới tương lai tốt đẹp hơn. Bỏ hết những chuyện không vui, làm người yêu anh 1 lần nữa, nha 💜</p>
      </div>
    </section>
  </div>

  <!-- Self-test results (ẩn) -->
  <details style="position:absolute; left:-9999px; top:-9999px;">
    <summary>Self tests</summary>
    <pre id="test-output"></pre>
  </details>

  <script>
  (() => {
    'use strict';

    // Tránh khởi tạo lặp lại nếu canvas tự reload
    if (window.__WE_HAVE_INIT__) {
      console.info('[WeHave] already initialized – skip re-init');
      return;
    }
    window.__WE_HAVE_INIT__ = true;

    // --- Time counters ---
    const START = new Date(2018, 7, 13); // 13/08/2018
    const yearVal = document.getElementById('yearVal');
    const dayVal = document.getElementById('dayVal');
    const secondVal = document.getElementById('secondVal');

    function fullDaysSince(s, n){
      const startD = new Date(s.getFullYear(), s.getMonth(), s.getDate());
      const nowD = new Date(n.getFullYear(), n.getMonth(), n.getDate());
      return Math.floor((nowD - startD) / 86400000);
    }
    function fullSecondsSince(s, n){ return Math.floor((n - s) / 1000); }
    function fullYearsSince(s, n){
      let y = n.getFullYear() - s.getFullYear();
      if (n.getMonth() < s.getMonth() || (n.getMonth() === s.getMonth() && n.getDate() < s.getDate())) y--;
      return y;
    }
    function updateCounters(){
      const now = new Date();
      yearVal.textContent = fullYearsSince(START, now);
      dayVal.textContent = fullDaysSince(START, now);
      secondVal.textContent = fullSecondsSince(START, now);
    }
    updateCounters();
    const counterTimer = setInterval(updateCounters, 1000);

    // --- Rain effect (mobile-safe) ---
    const fit = document.getElementById('fit');
    const original = document.getElementById('original');
    const extra = document.getElementById('extra');
    const rainTop = document.getElementById('rainTop');
    const rainExtra = document.getElementById('rainExtra');

    // Cập nhật quãng rơi theo chiều cao thực của từng container
    function setFallDistanceFor(el, container){
      if (!el || !container) return;
      const h = container.offsetHeight || fit.offsetHeight || window.innerHeight;
      el.style.setProperty('--fall-distance', h + 'px');
      el.style.transform = 'translateZ(0)'; // nudge compositing on iOS
    }
    function setAllFallDistances(){
      setFallDistanceFor(rainTop, original);
      setFallDistanceFor(rainExtra, extra);
    }
    setAllFallDistances();

    // Resize & orientation change
    window.addEventListener('resize', setAllFallDistances, { passive:true });

    // Debounce bằng rAF khi cuộn nhanh, và giảm spawn tạm thời để tránh jank
    let rafId = null, speedFactor = 1, lastY = 0, lastT = performance.now();
    fit.addEventListener('scroll', () => {
      const now = performance.now();
      const y = fit.scrollTop; const dy = Math.abs(y - lastY); const dt = Math.max(16, now - lastT);
      const v = dy / dt; // px/ms
      speedFactor = v > 1.2 ? 0.3 : v > 0.6 ? 0.6 : 1; // giảm tạm spawn khi kéo rất nhanh
      lastY = y; lastT = now;
      if (rafId) return;
      rafId = requestAnimationFrame(() => { setAllFallDistances(); rafId = null; });
    }, { passive:true });

    const rand = (min, max) => Math.random() * (max - min) + min;

    // Giới hạn phần tử để tránh rò rỉ bộ nhớ lúc cuộn lâu
    const MAX_DROPS_PER_LAYER = 160;
    function trimDrops(layer){
      if (!layer) return;
      while (layer.childElementCount > MAX_DROPS_PER_LAYER) {
        layer.removeChild(layer.firstElementChild);
      }
    }

    function spawnDrop(layer){
      if (!layer) return;
      const isCat = Math.random() < 0.35;
      const span = document.createElement('span');
      span.className = `drop ${isCat ? 'cat' : 'heart'}`;
      span.textContent = isCat ? '😺' : '💜';
      span.style.fontSize = (isCat ? rand(28, 44) : rand(18, 32)) + 'px';
      span.style.left = rand(0, 100) + '%';
      span.style.animation = `fallFade ${rand(5, 10)}s linear`;
      span.style.animationFillMode = 'forwards';
      layer.appendChild(span);
      span.addEventListener('animationend', () => span.remove(), { once:true });
      trimDrops(layer);
    }

    let rainTimer = null;
    function startRain(){
      if (rainTimer) return;
      rainTimer = setInterval(() => {
        const nTop = Math.floor(rand(1, 4) * speedFactor);
        const nExtra = Math.floor(rand(1, 4) * speedFactor);
        for (let i = 0; i < nTop; i++) spawnDrop(rainTop);
        for (let i = 0; i < nExtra; i++) spawnDrop(rainExtra);
      }, 300);
    }
    function stopRain(){ if (rainTimer) { clearInterval(rainTimer); rainTimer = null; } }

    document.addEventListener('visibilitychange', () => { if (document.hidden) stopRain(); else startRain(); });
    startRain();

    // --- Image stacks (giữ nguyên) ---
    const LINKS = [
      'https://i.postimg.cc/kVHYddxK/Image-Aug-09-2025.png',
      'https://i.postimg.cc/FfYGpn2R/IMG-Aug-09-2025.jpg',
      'https://i.postimg.cc/PC32mkV9/IMG-Aug-09-2025-1.jpg',
      'https://i.postimg.cc/Vry9RsqG/IMG-20250809-214449.jpg',
      'https://i.postimg.cc/vxbWJPS5/IMG-20250809-214413.jpg'
    ];

    const stackEl = document.getElementById('imgStack');
    const stackElSecondary = document.getElementById('imgStackSecondary');
    const rotatedLinks = LINKS.slice(1).concat(LINKS[0]);

    rotatedLinks.forEach(src => {
      const img = document.createElement('img');
      img.src = src; img.referrerPolicy = 'no-referrer'; img.crossOrigin = 'anonymous';
      stackEl.appendChild(img.cloneNode());
    });

    LINKS.forEach(src => {
      const img = document.createElement('img');
      img.src = src; img.referrerPolicy = 'no-referrer'; img.crossOrigin = 'anonymous';
      stackElSecondary.appendChild(img);
    });

    const rotateTimer = setInterval(() => {
      const imgs = [...stackEl.children]; if (imgs.length) stackEl.appendChild(imgs.shift());
      const imgs2 = [...stackElSecondary.children]; if (imgs2.length) stackElSecondary.appendChild(imgs2.shift());
    }, 2000);

    // --- Self-tests: giữ test cũ + bổ sung test chống cuộn ngang & quãng rơi ---
    (function runSelfTests(){
      const out = [];
      const log = (ok, name, got, exp) => {
        const icon = ok ? '✅' : '❌';
        const line = `${icon} ${name} | got: ${got} | expected: ${exp}`;
        (ok ? console.log : console.error)(line);
        out.push(line);
      };
      const s = new Date(2018, 7, 13);
      // Giữ nguyên test cũ
      const _fullDays = (s, n) => { const sd = new Date(s.getFullYear(), s.getMonth(), s.getDate()); const nd = new Date(n.getFullYear(), n.getMonth(), n.getDate()); return Math.floor((nd - sd) / 86400000);} 
      const _fullYears = (s, n) => { let y = n.getFullYear() - s.getFullYear(); if (n.getMonth() < s.getMonth() || (n.getMonth() === s.getMonth() && n.getDate() < s.getDate())) y--; return y; }
      const _fullSecs = (s, n) => Math.floor((n - s) / 1000);
      log(_fullDays(s, new Date(2018, 7, 14)) === 1, 'fullDaysSince +1 day', _fullDays(s, new Date(2018,7,14)), 1);
      log(_fullYears(s, new Date(2019, 7, 12)) === 0, 'fullYearsSince before anniversary', _fullYears(s, new Date(2019,7,12)), 0);
      log(_fullYears(s, new Date(2019, 7, 13)) === 1, 'fullYearsSince on anniversary', _fullYears(s, new Date(2019,7,13)), 1);
      log(_fullSecs(s, new Date(s.getTime() + 61000)) === 61, 'fullSecondsSince +61s', _fullSecs(s, new Date(s.getTime()+61000)), 61);

      // Bổ sung: không cuộn ngang (page & .fit)
      const sw = document.documentElement.scrollWidth, cw = document.documentElement.clientWidth;
      log(sw <= cw + 1, 'No horizontal scroll (page)', `${sw}px`, `<= ${cw+1}px`);
      const fitEl = document.getElementById('fit');
      log(fitEl.scrollWidth <= fitEl.clientWidth + 1, 'No horizontal scroll (.fit)', `${fitEl.scrollWidth}px`, `<= ${fitEl.clientWidth+1}px`);

      // Bổ sung: biến quãng rơi đã được set > 0 cho cả 2 lớp mưa
      const dTop = parseInt(getComputedStyle(rainTop).getPropertyValue('--fall-distance')) || 0;
      const dExtra = parseInt(getComputedStyle(rainExtra).getPropertyValue('--fall-distance')) || 0;
      log(dTop > 0, 'fall-distance top > 0', dTop, '>0');
      log(dExtra > 0, 'fall-distance extra > 0', dExtra, '>0');

      const pre = document.getElementById('test-output'); if (pre) pre.textContent = out.join('\n');
      document.documentElement.setAttribute('data-tests', out.some(l => l.startsWith('❌')) ? 'failed' : 'passed');
    })();

    // Optional teardown hook
    window.__WE_HAVE_APP__ = {
      teardown(){
        clearInterval(counterTimer);
        stopRain();
        clearInterval(rotateTimer);
        window.removeEventListener('resize', setAllFallDistances);
        fit.removeEventListener('scroll', setAllFallDistances);
      }
    };
  })();
  </script>

  <!-- ========================= -->
  <!-- PASSCODE OVERLAY (1308)  -->
  <!-- ========================= -->
  <script>
  (function(){
    'use strict';
    if (window.__PIN_OVERLAY_INIT__) return; // tránh khởi tạo 2 lần khi Canvas reload
    window.__PIN_OVERLAY_INIT__ = true;

    // Cấu hình — để tránh bị hỏi lại khi Canvas auto-reload, mặc định chỉ hỏi MỖI PHIÊN.
    // Đổi ALWAYS_ASK thành true nếu bạn muốn lúc nào mở trang cũng phải nhập mã.
    const ALWAYS_ASK = false;
    const PASS_KEY = 'pass_ok_1308';
    const CORRECT = '1308';

    try {
      if (!ALWAYS_ASK && sessionStorage.getItem(PASS_KEY) === '1') return; // đã mở khóa trong phiên
    } catch (e) { /* sessionStorage có thể không khả dụng ở chế độ riêng tư */ }

    const css = `
    .pc-overlay{position:fixed; inset:0; z-index:2147483647; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.45); backdrop-filter:saturate(1.2) blur(12px)}
    .pc-wrap{width:min(380px,92vw); color:#fff; text-align:center; user-select:none}
    .pc-title{font-weight:600; font-size:20px; opacity:.95; margin-bottom:14px}
    .pc-dots{display:flex; justify-content:center; gap:14px; margin:6px 0 16px}
    .pc-dot{width:14px; height:14px; border-radius:50%; border:2px solid rgba(255,255,255,.6); background:transparent}
    .pc-dot.filled{background:#fff; border-color:#fff}
    .pc-msg{min-height:18px; font-size:13px; color:#ffb4b4; margin-bottom:8px; opacity:0; transition:opacity .2s ease}
    .pc-msg.show{opacity:1}
    .pc-keypad{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:10px}
    .pc-key{aspect-ratio:1/1; border-radius:999px; display:flex; align-items:center; justify-content:center; font-size:24px; line-height:1; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); cursor:pointer; -webkit-tap-highlight-color:transparent}
    .pc-key:active{background:rgba(255,255,255,.16)}
    .pc-sub{display:block; font-size:10px; opacity:.65; margin-top:2px}
    .pc-empty{pointer-events:none; opacity:0}
    .pc-ops{display:flex; justify-content:space-between; margin-top:14px}
    .pc-op{font-size:14px; opacity:.9; cursor:pointer; padding:6px 10px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1)}
    .pc-op:active{background:rgba(255,255,255,.12)}
    @keyframes pc-shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(8px)}60%{transform:translateX(-6px)}80%{transform:translateX(4px)}}
    .pc-wrap.error{animation:pc-shake .36s ease}
    .pc-fade{animation:pc-fade .24s ease forwards}
    @keyframes pc-fade{to{opacity:0; visibility:hidden}}
    `;

    const style = document.createElement('style');
    style.textContent = css; document.head.appendChild(style);

    const overlay = document.createElement('div');
    overlay.className = 'pc-overlay';
    overlay.setAttribute('role','dialog');
    overlay.setAttribute('aria-modal','true');
    overlay.setAttribute('aria-label','Nhập mật mã để vào trang');

    overlay.innerHTML = `
      <div class="pc-wrap" id="pcWrap">
        <div class="pc-title">Nhập mật mã</div>
        <div class="pc-dots" aria-label="Trạng thái nhập">
          <span class="pc-dot" id="d1"></span>
          <span class="pc-dot" id="d2"></span>
          <span class="pc-dot" id="d3"></span>
          <span class="pc-dot" id="d4"></span>
        </div>
        <div class="pc-msg" id="pcMsg">Mật mã không đúng</div>
        <div class="pc-keypad" id="pcPad">
          ${[1,2,3,4,5,6,7,8,9].map(n => `<button class="pc-key" data-key="${n}" aria-label="${n}">${n}</button>`).join('')}
          <div class="pc-key pc-empty" aria-hidden="true"></div>
          <button class="pc-key" data-key="0" aria-label="0">0</button>
          <button class="pc-key" data-action="del" aria-label="Xoá">⌫</button>
        </div>
        <div class="pc-ops">
          <button class="pc-op" data-action="clear" aria-label="Xoá hết">Xoá hết</button>
          <button class="pc-op" data-action="close" aria-label="Ẩn bàn phím">Ẩn</button>
        </div>
      </div>`;

    // Gắn vào DOM & khoá cuộn nền
    document.body.appendChild(overlay);
    const prevOverflow = document.documentElement.style.overflow;
    document.documentElement.style.overflow = 'hidden';

    const wrap = overlay.querySelector('#pcWrap');
    const msg = overlay.querySelector('#pcMsg');
    const dots = [overlay.querySelector('#d1'), overlay.querySelector('#d2'), overlay.querySelector('#d3'), overlay.querySelector('#d4')];

    let input = '';
    const setDots = () => dots.forEach((d,i)=> d.classList.toggle('filled', i < input.length));
    const showError = () => { msg.classList.add('show'); wrap.classList.remove('error'); void wrap.offsetWidth; wrap.classList.add('error'); try{ navigator.vibrate && navigator.vibrate(160);}catch(_){} };
    const hideError = () => msg.classList.remove('show');

    function unlock(){
      try { sessionStorage.setItem(PASS_KEY, '1'); } catch (e) {}
      overlay.classList.add('pc-fade');
      setTimeout(()=>{ overlay.remove(); document.documentElement.style.overflow = prevOverflow || ''; }, 240);
    }

    function pressDigit(d){
      if (input.length >= 4) return;
      input += d;
      hideError();
      setDots();
      if (input.length === 4){
        setTimeout(() => {
          if (input === CORRECT) unlock();
          else { input = ''; setDots(); showError(); }
        }, 90);
      }
    }

    function backspace(){ if (!input) return; input = input.slice(0,-1); hideError(); setDots(); }
    function clearAll(){ input = ''; hideError(); setDots(); }

    overlay.addEventListener('click', (e) => {
      const t = e.target;
      if (t.matches('[data-key]')) { pressDigit(t.getAttribute('data-key')); }
      else if (t.matches('[data-action="del"]')) backspace();
      else if (t.matches('[data-action="clear"]')) clearAll();
      else if (t.matches('[data-action="close"]')) { /* ẩn bàn phím nhưng KHÔNG cho vào trang */ overlay.blur(); }
    });

    // Hỗ trợ bàn phím vật lý
    document.addEventListener('keydown', (e) => {
      if (!document.body.contains(overlay)) return;
      if (/^\d$/.test(e.key)) pressDigit(e.key);
      else if (e.key === 'Backspace') backspace();
      else if (e.key === 'Escape') clearAll();
    });

    // Focus trap thô sơ
    overlay.tabIndex = -1; overlay.focus();
  })();
  </script>
</body>
</html>
